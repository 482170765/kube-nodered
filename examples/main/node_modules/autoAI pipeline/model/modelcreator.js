const fs = require('fs');
const util = require('util');
const snippets = require('../snippets');

module.exports = function(RED) {
    function ModelCreator(config) {
        RED.nodes.createNode(this,config);
        var node = this;
        var model_name = config.model_name;
        var script = '';
        var epochs = config.epochs;
        var overwrite = config.overwrite;
        RED.httpAdmin.post("/model/:id", RED.auth.needsPermission('model.read'), function(req, res) {
            var filePath = req.body.filePath;
            
            
            
            if(fs.existsSync(filePath)) {
                res.json({fileExists: true});
            } else {
                res.json({fileExists: false});
            }
        });
        node.on('input', function(msg) {
            script += util.format(snippets.DEPLOY, epochs, model_name);
            msg.payload += script;
            let path = `/data/main/py/${model_name}.py`
            if (overwrite) {
                 fs.writeFile(path, msg.payload, function (err) {
                    if (err) {
                        node.error('Failed to write to file: ' + err.message);
                        return;
                    }
                });
            } else {
                fs.appendFile(path, msg.payload, function (err) {
                    if (err) {
                        node.error('Failed to write to file: ' + err.message);
                        return;
                    }
                });
            }
            msg.payload = path; 
            node.send(msg);
        });
    }
    RED.nodes.registerType("model creator", ModelCreator);
}






